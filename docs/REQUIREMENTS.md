# 作业管理系统需求规格

> 版本：v2.3
> 更新日期：2026-01-26
> 作者：AptS-1547, AptS-1548

---

## 一、系统概述

### 1.1 系统定位

教育作业管理平台后端服务，面向学校/培训机构，支持班级管理、作业发布、提交批改、实时通知等功能。

### 1.2 技术栈

| 组件 | 技术选型 |
|------|----------|
| Web 框架 | Actix Web 4.x |
| ORM | SeaORM 2.x |
| 数据库 | SQLite（开发）/ PostgreSQL（生产） |
| 缓存 | Moka（内存）/ Redis（可选） |
| 认证 | JWT 双 Token 机制 |
| 实时通信 | WebSocket（actix-web-actors） |
| 序列化 | Serde + ts-rs（TypeScript 类型生成） |

### 1.3 设计原则

1. **类型安全** - Rust 编译期保证 + TypeScript 类型自动生成
2. **分层架构** - Routes → Services → Storage → Entity
3. **插件化** - 缓存后端、数据库后端可切换
4. **安全优先** - JWT、速率限制、CORS、密码策略

---

## 二、用户角色与权限

### 2.1 系统角色（UserRole）

系统级角色决定用户的全局权限。

| 角色 | 英文 | 权限描述 |
|------|------|----------|
| 管理员 | Admin | 系统最高权限，可管理所有用户、班级、作业 |
| 教师 | Teacher | 可创建和管理自己的班级、发布作业、批改作业 |
| 普通用户 | User | 基础权限，可加入班级、提交作业 |

**权限继承**：
- Admin 拥有所有权限
- Teacher 拥有 User 的所有权限
- 权限检查时支持 `any` 模式（满足任一即可）

### 2.2 班级角色（ClassUserRole）

班级角色决定用户在特定班级内的权限。

| 角色 | 英文 | 权限描述 |
|------|------|----------|
| 班级教师 | Teacher | 发布作业、评分、管理成员、查看所有提交 |
| 课代表 | ClassRepresentative | 查看提交情况（谁交了谁没交），**不能评分** |
| 学生 | Student | 提交作业、查看自己的成绩和提交历史 |

**关键约束**：
- 一个用户可以加入多个班级
- 一个用户在每个班级只能有一个角色
- 课代表**不能**给作业评分，只能查看提交情况

### 2.3 权限矩阵

#### 班级管理权限

| 操作 | Admin | Teacher | User |
|------|-------|---------|------|
| 创建班级 | ✅（需指定教师） | ✅（自动绑定为负责教师） | ❌ |
| 查看所有班级 | ✅ | ❌ | ❌ |
| 查看自己的班级 | ✅ | ✅ | ✅ |
| 更新班级 | ✅ | ✅（自己创建的） | ❌ |
| 删除班级 | ✅ | ✅（自己创建的） | ❌ |

**说明**：
- 管理员创建班级时必须通过 `teacher_id` 参数指定负责该班级的教师
- 教师创建班级时自动成为该班级的负责教师，无需指定 `teacher_id`

#### 班级内操作权限

| 操作 | ClassTeacher | ClassRep | Student |
|------|--------------|----------|---------|
| 发布作业 | ✅ | ❌ | ❌ |
| 更新/删除作业 | ✅ | ❌ | ❌ |
| 查看作业列表 | ✅ | ✅ | ✅ |
| 提交作业 | ❌ | ✅ | ✅ |
| 查看所有提交 | ✅ | ✅ | ❌ |
| 查看未交名单 | ✅ | ✅ | ❌ |
| 评分 | ✅ | ❌ | ❌ |
| 修改评分 | ✅ | ❌ | ❌ |
| 管理成员 | ✅ | ❌ | ❌ |

---

## 三、核心业务流程

### 3.1 作业生命周期

```
┌─────────────────────────────────────────────────────────┐
│                     教师创建作业                          │
│  ├─ 设置标题、描述、截止时间、最高分                        │
│  ├─ 可选：允许迟交、上传附件                               │
│  └─ 发布后通知班级所有学生                                 │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│                     学生提交作业                          │
│  ├─ 支持多次提交（版本控制）                               │
│  ├─ 每次提交生成新版本号（v1, v2, v3...）                  │
│  ├─ 自动检测是否迟交（is_late 标记）                       │
│  └─ 提交后通知教师                                        │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│                     教师评分                              │
│  ├─ 只有班级教师可以评分（课代表不能）                      │
│  ├─ 支持修改评分（updated_at 记录修改时间）                 │
│  ├─ 分数不能超过最高分（数据库约束）                        │
│  └─ 评分后通知学生                                        │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│                     统计查询                              │
│  ├─ 教师：提交率、成绩分布、未交名单                        │
│  ├─ 课代表：提交情况（谁交了谁没交）                        │
│  └─ 学生：自己的提交历史和成绩                             │
└─────────────────────────────────────────────────────────┘
```

### 3.2 提交版本控制

每次学生提交作业时：
1. 系统自动查询该学生对该作业的最新版本号
2. 新提交的版本号 = 最新版本号 + 1
3. 保留所有历史提交，不覆盖
4. 教师评分时默认显示最新提交

```
学生小明提交《数据结构作业》：
├─ 第1次提交 → version=1, submitted_at=2026-01-20 10:00
├─ 第2次提交 → version=2, submitted_at=2026-01-21 14:30
└─ 第3次提交 → version=3, submitted_at=2026-01-22 09:15 (最新)
```

### 3.3 迟交处理

```rust
// 提交时自动判断
if homework.deadline.is_some() && now > homework.deadline {
    if homework.allow_late {
        submission.status = "late";
        submission.is_late = true;
    } else {
        return Err("作业已截止，不允许迟交");
    }
}
```

### 3.4 通知触发时机

| 事件 | 通知对象 | 通知内容 |
|------|----------|----------|
| 新作业发布 | 班级所有学生 | "《xxx》作业已发布" |
| 作业更新 | 班级所有学生 | "《xxx》作业已更新" |
| 作业即将截止 | 未提交的学生 | "《xxx》作业将于X小时后截止" |
| 收到新提交 | 班级教师 | "xxx 提交了《xxx》作业" |
| 收到评分 | 提交者 | "《xxx》作业已批改，得分 xx" |
| 评分修改 | 提交者 | "《xxx》作业评分已更新" |
| 加入班级 | 班主任 | "xxx 加入了班级" |
| 角色变更 | 被变更者 | "你的班级角色已变更为 xxx" |

---

## 四、功能需求清单

### 4.1 认证模块

| 功能 | 状态 | 说明 |
|------|------|------|
| 用户登录 | ✅ 已实现 | 支持用户名/邮箱登录 |
| 用户注册 | ✅ 已实现 | |
| Token 刷新 | ✅ 已实现 | Refresh Token 机制 |
| 获取当前用户 | ✅ 已实现 | |
| 登出 | ❌ 未实现 | 清除 Refresh Token |
| 登录速率限制 | ✅ 已实现 | 5次/分钟/IP |
| 密码强度验证 | ✅ 已实现 | 8位+大小写+数字+弱密码检测 |

### 4.2 用户管理

| 功能 | 状态 | 说明 |
|------|------|------|
| 用户 CRUD | ✅ 已实现 | 仅管理员 |
| 用户状态管理 | ✅ 已实现 | Active/Suspended/Banned |

### 4.3 班级管理

| 功能 | 状态 | 说明 |
|------|------|------|
| 班级 CRUD | ✅ 已实现 | |
| 邀请码加入 | ✅ 已实现 | 6位随机码 |
| 成员管理 | ✅ 已实现 | |
| 角色变更通知 | ✅ 已实现 | 触发 ClassRoleChanged 通知 |

### 4.4 作业管理

| 功能 | 状态 | 说明 |
|------|------|------|
| 创建作业 | ✅ 已实现 | |
| 更新作业 | ✅ 已实现 | |
| 删除作业 | ✅ 已实现 | |
| 作业详情 | ✅ 已实现 | |
| 作业列表 | ✅ 已实现 | 完整分页查询 |
| 作业统计 | ✅ 已实现 | 提交率、成绩分布、未交名单 |
| 作业附件 | ✅ 已实现 | homework_files 关联表 |

### 4.5 提交管理

| 功能 | 状态 | 说明 |
|------|------|------|
| 提交作业 | ✅ 已实现 | 支持版本控制 |
| 查看提交历史 | ✅ 已实现 | 某学生所有版本 |
| 查看最新提交 | ✅ 已实现 | |
| 撤回提交 | ⚠️ 部分实现 | 路由已有，缺少截止前可撤回的业务校验 |
| 提交附件 | ✅ 已实现 | submission_files 关联表 |

### 4.6 评分管理

| 功能 | 状态 | 说明 |
|------|------|------|
| 创建评分 | ✅ 已实现 | 仅班级教师 |
| 修改评分 | ✅ 已实现 | 记录 updated_at |
| 查看评分 | ✅ 已实现 | |

### 4.7 文件管理

| 功能 | 状态 | 说明 |
|------|------|------|
| 文件上传 | ✅ 已实现 | |
| 文件下载 | ✅ 已实现 | Token 化 |
| 附件关联 | ✅ 已实现 | homework_files, submission_files |
| 引用计数 | ✅ 已实现 | increment_file_citation_impl |

### 4.8 通知系统

| 功能 | 状态 | 说明 |
|------|------|------|
| 站内消息 | ✅ 已实现 | notifications 表 |
| WebSocket 推送 | ✅ 已实现 | 实时通知 |
| 已读状态 | ✅ 已实现 | |
| 消息类型 | ✅ 已实现 | 8种通知类型全部已实现 |

### 4.9 统计功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 作业提交率 | ✅ 已实现 | 在作业统计 API 中 |
| 成绩分布 | ✅ 已实现 | 平均分、最高分、最低分 |
| 未交名单 | ✅ 已实现 | 在作业统计 API 中 |
| 学生完成情况 | ✅ 已实现 | GET /homeworks/my/stats |
| 跨班级作业列表 | ✅ 已实现 | GET /homeworks/all |
| 用户综合统计 | ✅ 已实现 | GET /users/me/stats |
| WebSocket 状态 | ✅ 已实现 | GET /ws/status |

---

## 五、非功能需求

### 5.1 性能要求

| 指标 | 要求 |
|------|------|
| API 响应时间 | P95 < 200ms |
| 并发用户数 | 支持 1000+ 同时在线 |
| WebSocket 连接数 | 支持 5000+ 同时连接 |
| 数据库查询 | 单次查询 < 50ms |

### 5.2 安全要求

| 要求 | 实现方式 |
|------|----------|
| 认证 | JWT 双 Token |
| 授权 | 三层权限（JWT + 系统角色 + 班级角色） |
| 防暴力破解 | 速率限制 |
| XSS 防护 | 响应 Content-Type 固定为 JSON |
| CSRF 防护 | SameSite Cookie |
| SQL 注入 | SeaORM 参数化查询 |

### 5.3 可用性要求

| 要求 | 实现方式 |
|------|----------|
| 优雅关闭 | SIGTERM 信号处理 |
| 缓存降级 | Redis 失败时回退到内存缓存 |
| 错误处理 | 统一错误码 + 友好消息 |
| 日志 | 结构化日志（tracing） |

### 5.4 可维护性要求

| 要求 | 实现方式 |
|------|----------|
| 代码规范 | Rust fmt + Clippy |
| 类型安全 | TypeScript 类型自动生成 |
| 文档 | API 文档 + 数据库设计文档 |
| 配置管理 | 环境分离（开发/生产） |

---

## 六、术语表

| 术语 | 说明 |
|------|------|
| Access Token | 短期令牌，用于 API 认证，有效期 15 分钟 |
| Refresh Token | 长期令牌，用于刷新 Access Token，有效期 7-30 天 |
| 班级角色 | 用户在特定班级内的权限角色 |
| 系统角色 | 用户的全局权限角色 |
| 邀请码 | 6位随机字符串，用于加入班级 |
| 版本控制 | 支持同一学生对同一作业多次提交，每次生成新版本 |

---

## 七、更新日志

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v2.3 | 2026-01-26 | 修正功能状态：登出未实现、附件功能已实现；新增跨班级作业列表、用户综合统计、WebSocket 状态 |
| v2.2 | 2026-01-26 | 更新功能状态：角色变更通知、学生完成情况统计、通知消息类型已实现 |
| v2.1 | 2026-01-24 | 根据实现审计更新功能状态：认证、作业、提交、评分、通知、统计模块 |
| v2.0 | 2026-01-24 | 重新设计：版本控制、通知系统、权限矩阵 |
| v1.0 | 2025-01-23 | 初始版本 |
